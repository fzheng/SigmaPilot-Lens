services:
  gateway:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: lens-gateway
    restart: unless-stopped
    # No external port exposure - only accessible within Docker network
    # Use 'expose' to make port available to other containers
    expose:
      - "8000"
    environment:
      - DATABASE_URL=postgresql://lens:${DB_PASSWORD:-lens}@postgres:5432/lens
      - REDIS_URL=redis://redis:6379
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FORMAT=json
      - RATE_LIMIT_PER_MIN=${RATE_LIMIT_PER_MIN:-60}
      - RATE_LIMIT_BURST=${RATE_LIMIT_BURST:-120}
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - lens-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: lens-worker
    restart: unless-stopped
    command: python -m src.workers.main
    healthcheck:
      disable: true
    environment:
      - DATABASE_URL=postgresql://lens:${DB_PASSWORD:-lens}@postgres:5432/lens
      - REDIS_URL=redis://redis:6379
      - FEATURE_PROFILE=${FEATURE_PROFILE:-trend_follow_v1}
      - TIMEFRAMES=${TIMEFRAMES:-15m,1h,4h}
      - AI_MODELS=${AI_MODELS:-chatgpt,gemini,claude,deepseek}
      # ChatGPT
      - MODEL_CHATGPT_PROVIDER=openai
      - MODEL_CHATGPT_API_KEY=${MODEL_CHATGPT_API_KEY}
      - MODEL_CHATGPT_MODEL_ID=${MODEL_CHATGPT_MODEL_ID:-gpt-4o}
      - MODEL_CHATGPT_TIMEOUT_MS=${MODEL_CHATGPT_TIMEOUT_MS:-30000}
      - MODEL_CHATGPT_MAX_TOKENS=${MODEL_CHATGPT_MAX_TOKENS:-1000}
      # Gemini
      - MODEL_GEMINI_PROVIDER=google
      - MODEL_GEMINI_API_KEY=${MODEL_GEMINI_API_KEY}
      - MODEL_GEMINI_MODEL_ID=${MODEL_GEMINI_MODEL_ID:-gemini-1.5-pro}
      - MODEL_GEMINI_TIMEOUT_MS=${MODEL_GEMINI_TIMEOUT_MS:-30000}
      - MODEL_GEMINI_MAX_TOKENS=${MODEL_GEMINI_MAX_TOKENS:-1000}
      # Claude
      - MODEL_CLAUDE_PROVIDER=anthropic
      - MODEL_CLAUDE_API_KEY=${MODEL_CLAUDE_API_KEY}
      - MODEL_CLAUDE_MODEL_ID=${MODEL_CLAUDE_MODEL_ID:-claude-sonnet-4-20250514}
      - MODEL_CLAUDE_TIMEOUT_MS=${MODEL_CLAUDE_TIMEOUT_MS:-30000}
      - MODEL_CLAUDE_MAX_TOKENS=${MODEL_CLAUDE_MAX_TOKENS:-1000}
      # DeepSeek
      - MODEL_DEEPSEEK_PROVIDER=deepseek
      - MODEL_DEEPSEEK_API_KEY=${MODEL_DEEPSEEK_API_KEY}
      - MODEL_DEEPSEEK_MODEL_ID=${MODEL_DEEPSEEK_MODEL_ID:-deepseek-chat}
      - MODEL_DEEPSEEK_TIMEOUT_MS=${MODEL_DEEPSEEK_TIMEOUT_MS:-30000}
      - MODEL_DEEPSEEK_MAX_TOKENS=${MODEL_DEEPSEEK_MAX_TOKENS:-1000}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FORMAT=json
      - RETRY_MAX=${RETRY_MAX:-5}
      - DLQ_ENABLED=${DLQ_ENABLED:-true}
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    networks:
      - lens-network
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    stop_grace_period: 30s

  redis:
    image: redis:7-alpine
    container_name: lens-redis
    restart: unless-stopped
    # No external port exposure - internal network only
    expose:
      - "6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - lens-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M

  postgres:
    image: postgres:15-alpine
    container_name: lens-postgres
    restart: unless-stopped
    # No external port exposure - internal network only
    expose:
      - "5432"
    environment:
      - POSTGRES_USER=lens
      - POSTGRES_PASSWORD=${DB_PASSWORD:-lens}
      - POSTGRES_DB=lens
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U lens"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - lens-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

volumes:
  redis_data:
  postgres_data:

networks:
  lens-network:
    driver: bridge
